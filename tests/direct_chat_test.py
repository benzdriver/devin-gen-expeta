"""
Direct Test for EnhancedChatRequirements Component

This script tests the EnhancedChatRequirements component by directly interacting with the API
and verifying the chat session functionality works correctly.
"""

import os
import sys
import time
import json
import requests
from datetime import datetime

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

API_URL = "http://localhost:8000"

def test_api_health():
    """Test if the API server is running and responding"""
    try:
        response = requests.get(f"{API_URL}/health")
        if response.status_code == 200:
            print("‚úÖ API server is running")
            return True
        else:
            print(f"‚ùå API server returned status code {response.status_code}")
            return False
    except requests.exceptions.ConnectionError:
        print("‚ùå Could not connect to API server")
        return False

def test_token_usage():
    """Test the token usage endpoint"""
    try:
        response = requests.get(f"{API_URL}/token/usage")
        if response.status_code == 200:
            token_data = response.json()
            print(f"‚úÖ Token usage endpoint working: {token_data}")
            return True
        else:
            print(f"‚ùå Token usage endpoint returned status code {response.status_code}")
            return False
    except Exception as e:
        print(f"‚ùå Error accessing token usage endpoint: {str(e)}")
        return False

def test_chat_session():
    """Test the chat session functionality"""
    print("\nüîç Testing Chat Session Functionality...")
    
    session_id = None
    try:
        initial_message = "I need a personal website with a blog functionality"
        
        payload = {
            "user_message": initial_message,
            "session_id": None  # Start a new session
        }
        
        print(f"üì§ Sending initial message: '{initial_message}'")
        response = requests.post(f"{API_URL}/chat/session", json=payload)
        
        if response.status_code == 200:
            data = response.json()
            session_id = data.get("session_id")
            messages = data.get("messages", [])
            
            print(f"‚úÖ New chat session created with ID: {session_id}")
            print(f"‚úÖ Received {len(messages)} messages in response")
            
            for i, msg in enumerate(messages):
                print(f"  Message {i+1}: {msg.get('role')} - {msg.get('content')[:50]}...")
            
            requires_clarification = data.get("requires_clarification", False)
            print(f"‚úÖ Requires clarification: {requires_clarification}")
            
            return True, session_id
        else:
            print(f"‚ùå Failed to create chat session: {response.status_code}")
            print(response.text)
            return False, None
    except Exception as e:
        print(f"‚ùå Error creating chat session: {str(e)}")
        return False, None

def test_follow_up_message(session_id):
    """Test sending a follow-up message"""
    if not session_id:
        print("‚ùå Cannot send follow-up message without session ID")
        return False
    
    try:
        follow_up_message = "I want to showcase my design work with images and descriptions. The blog should have categories and comments."
        
        payload = {
            "user_message": follow_up_message,
            "session_id": session_id
        }
        
        print(f"\nüì§ Sending follow-up message: '{follow_up_message}'")
        response = requests.post(f"{API_URL}/chat/session", json=payload)
        
        if response.status_code == 200:
            data = response.json()
            messages = data.get("messages", [])
            
            print(f"‚úÖ Continued chat session successfully")
            print(f"‚úÖ Received {len(messages)} messages in response")
            
            for i, msg in enumerate(messages):
                if i >= len(messages) - 2:  # Only show the last two messages
                    print(f"  Message {i+1}: {msg.get('role')} - {msg.get('content')[:50]}...")
            
            requires_clarification = data.get("requires_clarification", False)
            print(f"‚úÖ Requires clarification: {requires_clarification}")
            
            return True
        else:
            print(f"‚ùå Failed to continue chat session: {response.status_code}")
            print(response.text)
            return False
    except Exception as e:
        print(f"‚ùå Error continuing chat session: {str(e)}")
        return False

def test_confirmation_message(session_id):
    """Test sending a confirmation message"""
    if not session_id:
        print("‚ùå Cannot send confirmation message without session ID")
        return False
    
    try:
        confirmation_message = "Yes, that's correct. I confirm these requirements are what I want."
        
        payload = {
            "user_message": confirmation_message,
            "session_id": session_id
        }
        
        print(f"\nüì§ Sending confirmation message: '{confirmation_message}'")
        response = requests.post(f"{API_URL}/chat/session", json=payload)
        
        if response.status_code == 200:
            data = response.json()
            messages = data.get("messages", [])
            
            print(f"‚úÖ Confirmation sent successfully")
            print(f"‚úÖ Received {len(messages)} messages in response")
            
            for i, msg in enumerate(messages):
                if i >= len(messages) - 2:  # Only show the last two messages
                    print(f"  Message {i+1}: {msg.get('role')} - {msg.get('content')[:50]}...")
            
            expectation_id = data.get("expectation_id")
            if expectation_id:
                print(f"‚úÖ Found expectation ID in response data: {expectation_id}")
                return True, expectation_id
            
            for msg in messages:
                content = msg.get('content', '')
                if 'expectation_id' in content.lower():
                    print(f"‚úÖ Found expectation ID in message content")
                    import re
                    match = re.search(r'expectation_id[:\s]+([a-zA-Z0-9_-]+)', content, re.IGNORECASE)
                    if match:
                        expectation_id = match.group(1)
                        print(f"‚úÖ Extracted expectation ID: {expectation_id}")
                        return True, expectation_id
            
            try:
                print("‚ö†Ô∏è No expectation ID found in response, trying to get from memory system...")
                memory_response = requests.get(f"{API_URL}/memory/expectations/latest")
                if memory_response.status_code == 200:
                    memory_data = memory_response.json()
                    expectation_id = memory_data.get("id")
                    if expectation_id:
                        print(f"‚úÖ Retrieved expectation ID from memory: {expectation_id}")
                        return True, expectation_id
                    else:
                        print("‚ùå No expectation ID found in memory response")
                else:
                    print(f"‚ùå Failed to get latest expectation: {memory_response.status_code}")
            except Exception as memory_error:
                print(f"‚ùå Error accessing memory system: {str(memory_error)}")
            
            print("‚ö†Ô∏è Using session ID as fallback for expectation ID")
            return True, session_id
        else:
            print(f"‚ùå Failed to send confirmation: {response.status_code}")
            print(response.text)
            return False, None
    except Exception as e:
        print(f"‚ùå Error sending confirmation: {str(e)}")
        return False, None

def test_generate_code(expectation_id):
    """Test the code generation functionality"""
    if not expectation_id:
        print("‚ùå Cannot generate code without expectation ID")
        return False
    
    try:
        payload = {
            "expectation_id": expectation_id,
            "session_id": expectation_id  # Include session_id as fallback
        }
        
        print(f"\nüì§ Requesting code generation for expectation: {expectation_id}")
        response = requests.post(f"{API_URL}/generate", json=payload)
        
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ Code generation request accepted")
            print(f"DEBUG: Full response data: {data}")
            
            generation_id = data.get("generation_id") or data.get("id")
            
            if not generation_id and "generated_code" in data:
                print("‚úÖ Found generated code in response")
                generation_id = f"gen_{expectation_id}"  # Create a synthetic ID based on expectation
                
            if generation_id:
                print(f"‚úÖ Generation ID: {generation_id}")
                
                max_polls = 5
                poll_interval = 2
                
                if "generated_code" in data and data["generated_code"].get("files"):
                    print("‚úÖ Code generation completed successfully (files found in response)")
                    return True
                    
                for i in range(max_polls):
                    print(f"üìä Polling generation progress ({i+1}/{max_polls})...")
                    try:
                        progress_response = requests.get(f"{API_URL}/generate/progress/{generation_id}")
                        
                        if progress_response.status_code == 200:
                            progress_data = progress_response.json()
                            progress = progress_data.get("progress", 0)
                            status = progress_data.get("status", "unknown")
                            
                            print(f"‚úÖ Generation progress: {progress}%, Status: {status}")
                            
                            if status.lower() == "completed" or progress >= 100:
                                print("‚úÖ Code generation completed successfully")
                                return True
                            
                            if status.lower() == "failed":
                                print("‚ùå Code generation failed")
                                return False
                        else:
                            print(f"‚ö†Ô∏è Progress endpoint not available: {progress_response.status_code}")
                            if "generated_code" in data and data["generated_code"].get("files"):
                                print("‚úÖ Using files from initial response as generation is complete")
                                return True
                    except Exception as e:
                        print(f"‚ö†Ô∏è Error checking progress: {str(e)}")
                        if "generated_code" in data and data["generated_code"].get("files"):
                            print("‚úÖ Using files from initial response as generation is complete")
                            return True
                    
                    time.sleep(poll_interval)
                
                print("‚ö†Ô∏è Reached maximum polling attempts, generation may still be in progress")
                return True
            else:
                print("‚ùå No generation ID returned")
                return False
        else:
            print(f"‚ùå Failed to request code generation: {response.status_code}")
            print(response.text)
            return False
    except Exception as e:
        print(f"‚ùå Error requesting code generation: {str(e)}")
        return False

def main():
    """Main function to run the tests"""
    print("\nüöÄ Starting Direct Chat Component Test")
    print("=" * 80)
    
    api_running = test_api_health()
    token_usage_working = test_token_usage()
    
    if not api_running:
        print("\n‚ùå Cannot proceed with tests. Please ensure API server is running.")
        return
    
    chat_success, session_id = test_chat_session()
    
    if chat_success and session_id:
        follow_up_success = test_follow_up_message(session_id)
        
        if follow_up_success:
            confirmation_success, expectation_id = test_confirmation_message(session_id)
            
            if confirmation_success and expectation_id:
                generation_success = test_generate_code(expectation_id)
                
                print("\nüìä Test Summary")
                print("=" * 80)
                print(f"API Health: {'‚úÖ PASS' if api_running else '‚ùå FAIL'}")
                print(f"Token Usage: {'‚úÖ PASS' if token_usage_working else '‚ùå FAIL'}")
                print(f"Chat Session: {'‚úÖ PASS' if chat_success else '‚ùå FAIL'}")
                print(f"Follow-up Message: {'‚úÖ PASS' if follow_up_success else '‚ùå FAIL'}")
                print(f"Confirmation Message: {'‚úÖ PASS' if confirmation_success else '‚ùå FAIL'}")
                print(f"Code Generation: {'‚úÖ PASS' if generation_success else '‚ùå FAIL'}")
                
                if chat_success and follow_up_success and confirmation_success and generation_success:
                    print("\nüéâ All tests passed successfully!")
                else:
                    print("\n‚ö†Ô∏è Some tests failed. Please check the logs above for details.")
            else:
                print("\n‚ùå Confirmation message test failed. Cannot proceed with code generation.")
        else:
            print("\n‚ùå Follow-up message test failed. Cannot proceed with confirmation.")
    else:
        print("\n‚ùå Chat session test failed. Cannot proceed with follow-up messages.")

if __name__ == "__main__":
    main()
